---
title: 分布式全局链路跟踪
date: 2024-08-06 18:21:46
tags:
---

# 背景

分布式系统对于一次处理，调用了大量的服务，要理解一次处理的链路，需要对于系统很了解。不便于定位问题。

还原业务逻辑的全景图

# 传统方案



# 现在的方案

新方案可以采用分布式会话跟踪提供的分布式参数透传能力实现业务日志的动态串联：

分布式参数透传很像ThreadLocal

# 链路染色

当逻辑链路开启时，确定唯一标识

链路标识：业务标识 + 场景标识 + 执行标识

执行标识？？？

# 链路存储

将链路执行中上报的日志存储。分为链路日志，节点日志，业务日志

- 链路日志：链路单次执行中，从开始节点和结束节点的日志中提取的链路基本信息，包含链路类型、链路元信息、链路开始/结束时间等。
- 节点日志：链路单次执行中，已执行节点的基本信息，包含节点名称、节点状态、节点开始/结束时间等。
- 业务日志：链路单次执行中，已执行节点中的业务日志信息，包含日志级别、日志时间、日志数据等。

# Qtrace

## 传递链路信息

- 如果是同一个应用同一个线程，就将span放进Threadlocal里面，span包含traceId

- 如果需要通过网络，从ThreadLocal中取出span，通过中间件传输

# Dapper

三个目标

1. 低消耗
2. 应用级的透明：不需要应用的开发者配合
3. 延展性

# 总结

感觉就是通过在中间件埋点，传递traceId，往kafka发送消息，由消费者存在HBase里面。qtrace和mtrace都是这么做的。

# 参考

https://tech.meituan.com/2022/07/21/visualized-log-tracing.html

https://wiki.corp.qunar.com/display/ggcpb/QTrace

https://tech.meituan.com/2016/10/14/mt-mtrace.html
