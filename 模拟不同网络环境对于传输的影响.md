---
title: 模拟不同网络环境对于传输的影响
date: 2024-07-14 13:16:38
tags:
---



# 实验环境

两台在内网的机器（之所以要在内网，是为了避免复杂的网络状况，所以如果只有一台服务器的话，要用容器)

```
操作系统：ALinux 3
Python版本：Python 3.6.8
机器配置：2核 2G
```

# 实验目的

通过tc模拟可能出现的网络故障，用wireshark分析tcpdump抓取的网络包

# 实验设置

```shell
# 1.基准状态
# 2.延迟5ms
sudo tc qdisc add dev eth0 root netem delay 5ms
# 3.延迟50ms
sudo tc qdisc add dev eth0 root netem delay 50ms
# 4.延迟500ms
sudo tc qdisc add dev eth0 root netem delay 500ms
# 4.丢包率5%
sudo tc qdisc add dev eth0 root netem loss 5%
# 5.丢包率20%
sudo tc qdisc add dev eth0 root netem loss 20%
# 6.带宽1Mbps
sudo tc qdisc add dev eth0 root tbf rate 1mbit burst 32kbit latency 400ms
# 7.带宽50Mbps
sudo tc qdisc add dev eth0 root tbf rate 1mbit burst 32kbit latency 400ms
# 8.抖动10ms
sudo tc qdisc add dev eth0 root netem delay 100ms 10ms
# 9.乱序5%
sudo tc qdisc add dev eth0 root netem delay 10ms reorder 5%
# 10.乱序20%
sudo tc qdisc add dev eth0 root netem delay 10ms reorder 20%
```

# 实验工具

## tc

```shell
sudo yum install iproute-tc
```

# 实验步骤

## 创建服务器容器

创建Dockerfile

```dockerfile
FROM python:3.8-slim
WORKDIR /app
COPY . /app
EXPOSE 8089
CMD ["python", "-m", "http.server", "8089"]
```

创建一个2G文件

```shell
dd if=/dev/zero of=./1.img bs=1M count=2048
```

构建容器

```sh
podman build -t file-server .
```

创建网络

```sh
podman run -d --name server --network test-net -p 8089:8089 file-server
```

启动容器

```sh
podman run -d --name server --network test-net -p 8089:8089 file-server
```

## 创建客户端容器

使用centos创建容器后，下载curl命令失败。使用ubuntu创建后成功	

```sh
podman run -it --name client --network test-net ubuntu /bin/bash
```

下载curl

```sh
apt update
apt install -y curl
```

用curl访问服务器容器

```sh
curl http://server:8089/1.img > /dev/null
```

## 宿主机

用tcpdump监听8089端口，并重定向到文件，便于用wireshark进行分析

```sh
sudo tcpdump -i any port 8089 -w ./1.cap
```

查找出是这个设备`vethba4c3022`

用tc命令进行模拟

```sh
# 1.基准状态
# 2.延迟5ms
sudo tc qdisc add dev vethba4c3022 root netem delay 5ms
# 3.延迟50ms
sudo tc qdisc add dev vethba4c3022 root netem delay 50ms
# 4.延迟500ms
sudo tc qdisc add dev vethba4c3022 root netem delay 500ms
# 4.丢包率5%
sudo tc qdisc add dev vethba4c3022 root netem loss 5%
# 5.丢包率20%
sudo tc qdisc add dev vethba4c3022 root netem loss 20%
# 6.带宽1Mbps
sudo tc qdisc add dev vethba4c3022 root tbf rate 1mbit burst 32kbit latency 400ms
# 7.带宽50Mbps
sudo tc qdisc add dev vethba4c3022 root tbf rate 1mbit burst 32kbit latency 400ms
# 8.抖动10ms
sudo tc qdisc add dev vethba4c3022 root netem delay 100ms 10ms
# 9.乱序5%
sudo tc qdisc add dev vethba4c3022 root netem delay 10ms reorder 5%
# 10.乱序20%
sudo tc qdisc add dev vethba4c3022 root netem delay 10ms reorder 20%
```

启动服务

```shell
python3 -m http.server 8089
```

只有一台服务器，走回环网卡，访问localhost。

用tcpdump监听8089端口，并重定向到文件，便于用wireshark进行分析

```shell
sudo tcpdump -i lo port 8089 -w ./1.cap
```

用curl访问8089端口的文件，重定向到/dev/null，因为实际上不需要使用这个文件

```shell
curl http://localhost:8089/1.img > /dev/null
```

tc设置完一个实验之后需要清除

```sh
sudo tc qdisc del dev vethba4c3022 root
```

# 实验现象

## 1.基准状态

![image-20240716145318616](https://kjgadfk-1311071500.cos.ap-nanjing.myqcloud.com/image-20240716145318616.png)

## 2.延迟5ms

![image-20240716145440281](https://kjgadfk-1311071500.cos.ap-nanjing.myqcloud.com/image-20240716145440281.png)

## 3.延迟50ms

![image-20240716145359381](https://kjgadfk-1311071500.cos.ap-nanjing.myqcloud.com/image-20240716145359381.png)

## 4.延迟500ms

![image-20240716153051678](https://kjgadfk-1311071500.cos.ap-nanjing.myqcloud.com/image-20240716153051678.png)

# 背景知识

## tc

在Linux下进行流量控制的命令，可以用于模拟丢包延时。

## sysctl

用来调整linux的系统参数

## 

# 结论

1. 通过延迟5ms，50ms，500ms的下载速度不变，经过资料查询tc命令设置的延迟只在物理网卡上起作用。只能创建两个Docker来模拟实验。